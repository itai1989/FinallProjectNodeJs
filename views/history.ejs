<%- include('top') %>
<div>
  <h1> 住专转 转</h1>

  <form id="dateForm" onsubmit="fetchMeasurements(event)">
    <label>转专 转: <input type="date" id="startDate" required></label>
    <label>转专 住: <input type="date" id="endDate" required></label>
    <button type="submit"> 爪 转</button>
  </form>

  <h3>转爪转 转</h3>
  <table border="1">
    <thead>
      <tr>
        <th>转专</th>
        <th>注专 </th>
        <th>注专 </th>
        <th>驻拽</th>
      </tr>
    </thead>
    <tbody id="measurementsTable">
      <tr><td colspan="4"> 专  转专 爪 转爪转</td></tr>
    </tbody>
  </table>
</div>

<script>
  async function fetchMeasurements(event) {
    event.preventDefault();

    const userId = "<%= user_id %>";
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const tableBody = document.getElementById('measurementsTable');

    if (!startDate || !endDate) return alert("砖 专  转专!");

    try {
      const res = await fetch(`/measurements/history/${userId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ start_date: startDate, end_date: endDate })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.message);

      tableBody.innerHTML = "";
      if (data.measurements.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='4'> 爪 转  转专 砖专</td></tr>";
        return;
      }

      data.measurements.forEach(m => {
        const row = document.createElement("tr");

        let lowColor = m.is_low_low ? "blue" : "black"; // 专拽  爪注 砖 专
        let highColor = m.is_high ? "red" : "black";
        let pulseColor = m.is_pulse_high ? "red" : m.is_pulse_low ? "blue" : "black";

        row.innerHTML = `
          <td>${m.time.split("T")[0]}</td>
          <td style="color: ${lowColor}">${m.lowValue}</td>
          <td style="color: ${highColor}">${m.highValue}</td>
          <td style="color: ${pulseColor}">${m.pulse}</td>
        `;
        tableBody.appendChild(row);
      });
    } catch (error) {
      tableBody.innerHTML = <tr><td colspan="4">${error.message}</td></tr>;
    }
  }
</script>

<%- include('bottom') %>